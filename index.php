<?php
require 'db.php';
session_start();

$page = isset($_GET['page']) ? $_GET['page'] : 'login';
$error = '';
$success = '';

// Proses Registrasi
if ($_SERVER['REQUEST_METHOD'] === 'POST' && $page === 'register') {
    $username = trim($_POST['username']);
    $password = password_hash($_POST['password'], PASSWORD_DEFAULT);

    if ($username && $password) {
        $stmt = $conn->prepare("INSERT INTO users (username, password) VALUES (:username, :password)");
        $stmt->bindParam(':username', $username);
        $stmt->bindParam(':password', $password);
        try {
            $stmt->execute();
            $success = "Registrasi berhasil! Silakan login.";
            $page = 'login';
        } catch (PDOException $e) {
            $error = "Gagal mendaftar: Username sudah digunakan.";
        }
    } else {
        $error = "Isi semua kolom.";
    }
}

// Proses Login
if ($_SERVER['REQUEST_METHOD'] === 'POST' && $page === 'login') {
    $username = trim($_POST['username']);
    $password = $_POST['password'];

    $stmt = $conn->prepare("SELECT * FROM users WHERE username = :username");
    $stmt->bindParam(':username', $username);
    $stmt->execute();

    $user = $stmt->fetch(PDO::FETCH_ASSOC);

    if ($user && password_verify($password, $user['password'])) {
        $_SESSION['user_id'] = $user['id'];
        $_SESSION['username'] = $user['username'];
        header('Location: index.php?page=home');
        exit;
    } else {
        $error = "Username atau password salah.";
    }
}

// Proses Logout
if ($page === 'logout') {
    session_destroy();
    header('Location: index.php?page=login');
    exit;
}
?>

<!DOCTYPE html>
<html>
<head>
    <title>Web Sederhana</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
    <?php if ($page === 'register'): ?>
        <h2>Registrasi</h2>
        <?php if ($error) echo "<p class='error'>$error</p>"; ?>
        <?php if ($success) echo "<p class='success'>$success</p>"; ?>
        <form method="POST" action="?page=register">
            <label>Username:</label>
            <input type="text" name="username" required>
            <label>Password:</label>
            <input type="password" name="password" required>
            <button type="submit">Daftar</button>
        </form>
        <a href="?page=login">Sudah punya akun? Login</a>

    <?php elseif ($page === 'login'): ?>
        <h2>Login</h2>
        <?php if ($error) echo "<p class='error'>$error</p>"; ?>
        <?php if ($success) echo "<p class='success'>$success</p>"; ?>
        <form method="POST" action="?page=login">
            <label>Username:</label>
            <input type="text" name="username" required>
            <label>Password:</label>
            <input type="password" name="password" required>
            <button type="submit">Login</button>
        </form>
        <a href="?page=register">Belum punya akun? Daftar</a>

    <?php elseif ($page === 'home' && isset($_SESSION['user_id'])): ?>
        <h2>Selamat Datang, <?php echo htmlspecialchars($_SESSION['username']); ?>!</h2>
        <p>Anda berhasil login ke sistem. Gunakan menu di bawah ini untuk melanjutkan.</p>
        <div class="home-actions">
            <button onclick="location.href='?page=logout'">Logout</button>
        </div>
    <?php else: ?>
        <p>Akses tidak sah. <a href="?page=login">Login di sini</a>.</p>
    <?php endif; ?>
</div>
</body>
</html>
